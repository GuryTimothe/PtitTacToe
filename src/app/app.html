<main class="app-shell">
  <section class="game-panel">
    <header class="panel-header">
      <p class="eyebrow">Ptit-Tac-Toe</p>
      <h1>{{ title() }}</h1>
      <div class="players">
        <div class="player-tag">
          <span>You:</span>
          <strong>{{ username() || 'Anonymous' }}</strong>
          <span class="role">({{ localPlayer() ?? '–' }})</span>
        </div>
        <div class="player-tag rival">
          <span>Opponent:</span>
          <strong>{{ opponentName() || 'Waiting…' }}</strong>
          <span class="role">({{ remotePlayerSymbol() ?? '–' }})</span>
        </div>
      </div>
      <p class="status" [class.won]="gameState().status === TicTacToeStatus.Won" [class.draw]="gameState().status === TicTacToeStatus.Draw">
        {{ statusMessage() }}
      </p>
      <p class="connection-status">
        <span [class.connected]="connectionReady()">{{ connectionLabel() }}</span>
      </p>
      @if (infoMessage()) {
        <p class="info-banner">{{ infoMessage() }}</p>
      }
      @if (errorMessage()) {
        <p class="error-banner">{{ errorMessage() }}</p>
      }
    </header>

    <section class="identity">
      <label for="username">Your username</label>
      <input
        id="username"
        name="username"
        type="text"
        maxlength="24"
        placeholder="Choose how others will see you"
        [ngModel]="username()"
        (ngModelChange)="username.set($event)"
      />
    </section>

    @if (!isConnected()) {
      <section class="lobby">
        <div class="lobby-card">
          <h2>Host a match</h2>
          <p>Become the X player and share your host ID.</p>
          <button type="button" (click)="startHosting()">Start hosting</button>
          @if (hostPeerId()) {
            <p class="share-id">
              Share your peer ID:<br />
              <code>{{ hostPeerId() }}</code>
            </p>
          }
        </div>
        <div class="lobby-card">
          <h2>Join a match</h2>
          <p>Enter your friend's host ID to play as O.</p>
          <label for="host-id">Host ID</label>
          <input
            id="host-id"
            name="hostId"
            type="text"
            placeholder="e.g. peer-id"
            [ngModel]="joinTargetId()"
            (ngModelChange)="joinTargetId.set($event)"
          />
          <button type="button" (click)="joinGame()">Join game</button>
        </div>
      </section>
    }

    @if (connectionState() === 'hosting' || connectionState() === 'joining') {
      <section class="session-actions">
        <button type="button" class="ghost" (click)="cancelConnection()">Cancel session</button>
      </section>
    }

    <section class="board-wrapper">
      <div
        class="board"
        [class.disabled]="!connectionReady() || gameState().status !== TicTacToeStatus.InProgress"
      >
        @for (cell of gameState().board; track $index) {
          <button
            class="cell"
            type="button"
            (click)="handleCellClick($index)"
            [disabled]="!canPlayCell($index)"
          >
            {{ cell ?? '·' }}
          </button>
        }
      </div>
      @if (!connectionReady()) {
        <div class="board-overlay">
          <p>Connect two peers to start the match.</p>
        </div>
      }
      <div class="board-foot">
        <button type="button" (click)="resetGame()" [disabled]="!connectionReady()">Reset match</button>
        <span class="turn-indicator" [class.active]="isPlayersTurn()">
          {{ isPlayersTurn() ? 'Your turn' : 'Waiting for opponent' }}
        </span>
      </div>
    </section>

    <section class="chat-panel">
      <header>
        <h2>P'tit chatbox</h2>
        <div>
          <input type="checkbox" [(ngModel)]="hasMutedChat" /> mute chat
        </div>
        <p>{{ chatMessages().length }} messages</p>
      </header>
      @if (!hasMutedChat){
        <div class="chat-log">
          @for (message of chatMessages(); track message.id) {
            <article class="chat-message" [class.self]="message.sender === 'self'">
              <div class="meta">
                <span class="author">{{ message.username }}</span>
                <span class="time">{{ formatTimestamp(message.timestamp) }}</span>
              </div>
              <p>{{ message.text }}</p>
            </article>
          }
          @empty {
            <p class="chat-empty">No messages yet. Say hi!</p>
          }
        </div>
        <form class="chat-input" (submit)="submitChat($event)">
          <input
            type="text"
            name="chatMessage"
            autocomplete="off"
            [placeholder]="chatPlaceholder()"
            [disabled]="!connectionReady()"
            [ngModel]="chatInput()"
            (ngModelChange)="chatInput.set($event)"
          />
          <button type="submit" [disabled]="!chatInput().trim() || !connectionReady()">Send</button>
        </form>
      } @else {
        <div>The chat has been muted</div>
      }

    </section>
  </section>
</main>

<router-outlet />
